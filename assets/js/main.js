const translations = {
    fr: {
        nav_home: "Accueil",
        nav_shop: "Boutique",
        nav_about: "À propos",
        nav_contact: "Contact",
        theme_toggle_light: "Mode clair",
        theme_toggle_dark: "Mode sombre",
        lang_toggle_to_en: "Passer en anglais",
        lang_toggle_to_fr: "Passer en français",
        account_link_label: "Mon compte",
        cta_cart: "Panier",
        hero_tag: "Nouvelle vague streetwear",
        hero_title: "Vision — L'élégance urbaine taillée pour le quotidien",
        hero_copy: "Des silhouettes minimalistes, des matières responsables et une allure qui capte l'instant. Découvrez des pièces pensées pour bouger avec vous.",
        hero_cta_primary: "Explorer la collection",
        hero_cta_secondary: "Voir les éditions limitées",
        hero_card_title: "Drop Vision 07",
        hero_card_copy: "Parka technique, hoodie double épaisseur, pantalon cargo texturé.",
        hero_card_link: "Découvrir la capsule",
        badge_new: "Nouveautés",
        highlight_tag: "Sélection lumineuse",
        highlight_title: "Une zone claire pour repérer vos prochains essentiels",
        highlight_copy: "Visualisez dès maintenant trois emplacements produits dédiés à vos futurs best-sellers Vision.",
        highlight_visual: "Visuel 4:5",
        highlight_product1_label: "Produit à venir",
        highlight_product1_name: "Emplacement produit n°1",
        highlight_product1_copy: "Réservez cet espace pour votre pièce phare : photo, nom, prix et appel à l'action s'y intégreront parfaitement.",
        highlight_product2_label: "Produit à venir",
        highlight_product2_name: "Emplacement produit n°2",
        highlight_product2_copy: "Mettez en avant une nouveauté ou une édition limitée avec visuel 3:4 et fiche descriptive concise.",
        highlight_product3_label: "Produit à venir",
        highlight_product3_name: "Emplacement produit n°3",
        highlight_product3_copy: "Préparez ici votre drop exclusif : matériaux, storytelling et boutons d'ajout au panier seront mis en valeur.",
        highlight_price_placeholder: "Prix à définir",
        highlight_cta: "Bientôt disponible",
        collections_tag: "Collections",
        collections_title: "Des pièces essentielles pour un dressing visionnaire",
        collections_copy: "Composez votre uniforme urbain avec des basiques revisités, des coupes oversize maîtrisées et des détails techniques pensés pour durer.",
        collection_metro_title: "Ligne Métropolis",
        collection_metro_copy: "Blousons modulaires, pantalons cargos ajustables et accessoires réfléchissants inspirés de la ville nocturne.",
        collection_metro_link: "Shopper la ligne",
        collection_essentials_title: "Essentials 24/7",
        collection_essentials_copy: "Hoodies premium, tees respirants et joggers sculptés pour l'agilité. Le confort sans compromis.",
        collection_essentials_link: "Shopper les essentiels",
        collection_fluid_title: "Fluid Dynamics",
        collection_fluid_copy: "Pièces unisexes, tissus techniques semi-transparents et superpositions légères inspirées du mouvement.",
        collection_fluid_link: "Shopper la capsule",
        values_tag: "Manifeste",
        values_title: "Un vestiaire engagé pour une communauté en mouvement",
        values_1: "Production responsable en ateliers certifiés en Europe et au Japon.",
        values_2: "Matériaux recyclés, coton bio, cuir vegan et emballages compostables.",
        values_3: "Création inclusive : coupes pensées pour toutes les morphologies.",
        values_cta: "Lire notre histoire",
        metric_satisfaction: "de clients satisfaits",
        metric_shipping: "Expédition moyenne",
        metric_cities: "Pays livrés",
        limited_tag: "Éditions limitées",
        limited_title: "Drops exclusifs & collaborations visionnaires",
        limited_copy: "Alertes en temps réel, quantités restreintes, design signature. Ne manquez aucun drop.",
        badge_collab: "Collaboration",
        badge_limited: "Série limitée",
        badge_restocks: "Restock",
        limited_card1_title: "Vision x Concrete Waves",
        limited_card1_copy: "Capsule inspirée des textures urbaines et des graffitis lumineux.",
        limited_card1_link: "Accéder au drop",
        limited_card2_title: "Programme Atelier 06",
        limited_card2_copy: "Pièces numérotées, broderies à la main, packaging signature Vision.",
        limited_card2_link: "Réserver",
        limited_card3_title: "Archive Restock",
        limited_card3_copy: "Les pièces iconiques reviennent en quantités très limitées.",
        limited_card3_link: "Être notifié·e",
        immersive_tag: "Vue 360°",
        immersive_title: "Interagissez avec nos pièces en 3D",
        immersive_copy: "Manipulez chaque vêtement, inspectez les textures et choisissez la combinaison qui vous ressemble. La technologie Vision 360° rend l'expérience d'achat tactile.",
        immersive_point1: "Visualisation multi-angle et zoom haute définition.",
        immersive_point2: "Prévisualisation des variations de couleurs en temps réel.",
        immersive_point3: "Compatibilité mobile, tablette et desktop.",
        immersive_note: "Aperçu prototype — la modélisation finale sera intégrée lors de la réception des fichiers 3D.",
        services_tag: "Services",
        services_title: "Une expérience e-commerce fluide et sécurisée",
        service_payment_title: "Paiement sécurisé",
        service_payment_copy: "Carte bancaire, PayPal et wallets numériques avec chiffrement AES-256.",
        service_delivery_title: "Livraison mondiale",
        service_delivery_copy: "Suivi en temps réel, partenaires DHL Express & Chronopost, options green.",
        service_returns_title: "Retours simplifiés",
        service_returns_copy: "Portail de retours intégré, étiquettes prépayées, remboursement rapide.",
        service_support_title: "Support humain",
        service_support_copy: "Équipe dédiée multilingue, réponses sous 24h et assistance live chat.",
        newsletter_tag: "Newsletter",
        newsletter_title: "Recevez les drops avant tout le monde",
        newsletter_copy: "Inscrivez-vous pour accéder aux préventes, codes promo exclusifs et invitations à nos évènements.",
        newsletter_label: "Votre email",
        newsletter_cta: "S'inscrire",
        footer_copy: "Vision réinvente les essentiels urbains avec un regard responsable et avant-gardiste.",
        footer_shop: "Boutique",
        footer_support: "Support",
        footer_legal: "Légal",
        footer_metro: "Ligne Métropolis",
        footer_essentials: "Essentials 24/7",
        footer_fluid: "Fluid Dynamics",
        footer_limited: "Drops exclusifs",
        footer_contact: "Nous contacter",
        footer_returns: "Politique de retour",
        footer_delivery: "Livraison & suivi",
        footer_privacy: "Confidentialité & cookies",
        footer_terms: "Mentions légales",
        footer_cgv: "Conditions générales de vente",
        footer_cookies: "Préférences cookies",
        footer_rights: "© Vision. Tous droits réservés.",
        footer_budget: "Budget : des toasts de chèvre ?",
        cookies_message: "Vision utilise des cookies pour personnaliser votre expérience. Choisissez vos préférences.",
        cookies_settings: "Paramétrer",
        cookies_accept: "Tout accepter",
        shop_tag: "Boutique",
        shop_title: "Composez votre uniforme urbain",
        shop_copy: "Filtrez par catégorie, taille, couleur ou disponibilité pour trouver la pièce Vision qui vous correspond.",
        filter_category: "Catégorie",
        filter_size: "Taille",
        filter_color: "Couleur",
        filter_availability: "Disponibilité",
        filter_all: "Toutes",
        filter_all_sizes: "Toutes",
        filter_all_colors: "Toutes",
        filter_metropolis: "Métropolis",
        filter_essentials: "Essentials",
        filter_fluid: "Fluid Dynamics",
        filter_limited: "Éditions limitées",
        filter_black: "Noir",
        filter_white: "Blanc",
        filter_grey: "Gris",
        filter_accent: "Accent chromé",
        filter_instock: "En stock",
        filter_preorder: "Précommande",
        filter_restock: "Restock",
        filter_apply: "Appliquer",
        filter_reset: "Réinitialiser",
        promo_title: "Utilisez le code VISION15",
        promo_copy: "15% de réduction sur votre première commande. Offre limitée aux 500 premiers clients.",
        cta_banner_title: "Besoin d'un conseil style ?",
        cta_banner_copy: "Réservez une session en visio avec nos stylistes Vision pour créer votre tenue idéale.",
        cta_banner_link: "Planifier une session",
        about_tag: "Notre univers",
        about_title: "Vision : l'esthétique streetwear pensée pour durer",
        about_intro: "Née dans les rues de Paris et façonnée par une communauté internationale, Vision repense les essentiels urbains avec exigence et conscience.",
        timeline_2016_title: "2016 — Origines",
        timeline_2016_copy: "Lancement de Vision avec une première série de hoodies produits en édition limitée et sérigraphiés à la main.",
        timeline_2018_title: "2018 — Communauté",
        timeline_2018_copy: "Ouverture du studio Vision à Paris, ateliers co-créatifs avec les clients et premières collaborations avec des artistes visuels.",
        timeline_2021_title: "2021 — Expansion",
        timeline_2021_copy: "Distribution internationale, lancement de la plateforme e-commerce et introduction des gammes techniques.",
        timeline_2024_title: "2024 — Innovation",
        timeline_2024_copy: "Intégration de la modélisation 3D, logistique bas carbone et programme de recyclage Vision Loop.",
        mission_tag: "Mission",
        mission_title: "Créer des pièces qui racontent les villes et respectent la planète",
        mission_copy: "Chaque collection est conçue à partir de matériaux premium et responsables. Nous travaillons avec des ateliers certifiés, privilégions des séries limitées pour éviter la surproduction et offrons une traçabilité complète.",
        vision_tag: "Vision",
        vision_title: "Une marque pensée pour la communauté",
        vision_copy: "Vision défend la diversité, l'inclusivité et l'expression personnelle. Nos campagnes donnent la parole aux clients, artistes, athlètes et créatifs qui nous inspirent.",
        pillars_title: "Nos piliers",
        pillar_design_title: "Design fonctionnel",
        pillar_design_copy: "Coupes étudiées, poches intelligentes, tissus respirants et résistance à l'eau pour accompagner les rythmes urbains.",
        pillar_culture_title: "Culture street",
        pillar_culture_copy: "Influencée par le skate, la musique électronique et l'art contemporain, Vision capte l'énergie des grandes villes.",
        pillar_responsibility_title: "Responsabilité",
        pillar_responsibility_copy: "Traçabilité complète, partenaires engagés, packaging recyclé et donation d'invendus à des associations.",
        team_title: "L'équipe Vision",
        team_copy: "Une équipe multidisciplinaire mêlant designers, stylistes, développeurs, logisticiens et storytellers.",
        team_aliyah: "Directrice créative — imagine les silhouettes et collabore avec des artistes émergents.",
        team_liam: "Head of Digital — pilote l'expérience e-commerce, la 3D et les innovations retail.",
        team_jade: "Responsable production — garantit la qualité, la traçabilité et la logistique bas carbone.",
        contact_tag: "Contact",
        contact_title: "Parlons de votre expérience Vision",
        contact_intro: "Support client, collaborations, presse ou wholesale — notre équipe est disponible en français et en anglais.",
        contact_name: "Nom complet",
        contact_email: "Email",
        contact_topic: "Sujet",
        contact_message: "Message",
        topic_support: "Support commande",
        topic_collab: "Collaboration",
        topic_press: "Presse",
        topic_wholesale: "Wholesale",
        contact_submit: "Envoyer",
        contact_support_title: "Support client",
        contact_support_copy: "Disponible du lundi au samedi, 9h-20h CET.",
        contact_press_title: "Presse & collaborations",
        contact_press_copy: "Envoyez vos dossiers de presse, portfolios et propositions de projets.",
        contact_store_title: "Showroom Vision",
        contact_store_copy: "Visite sur rendez-vous, essayage privé et personnalisation.",
        contact_cta_title: "Rejoignez la communauté Vision Loop",
        contact_cta_copy: "Recyclage de vêtements, offres exclusives et invitations à nos évènements immersifs.",
        contact_cta_button: "S'inscrire",
        account_tag: "Mon espace",
        account_title: "Gérez votre profil Vision",
        account_intro: "Suivez vos commandes, gérez vos adresses, vos préférences de livraison et vos listes d'envies.",
        account_login_title: "Connexion",
        account_register_title: "Créer un compte",
        account_tracking_title: "Suivi de commande",
        account_email: "Email",
        account_password: "Mot de passe",
        account_login_button: "Se connecter",
        account_forgot: "Mot de passe oublié ?",
        account_name: "Nom complet",
        account_preferences: "Préférences",
        pref_street: "Streetwear structuré",
        pref_casual: "Casual minimal",
        pref_limited: "Drops exclusifs",
        account_register_button: "Créer mon compte",
        account_newsletter: "Je souhaite recevoir la newsletter Vision.",
        account_tracking_number: "Numéro de commande",
        account_tracking_button: "Suivre",
        account_tracking_copy: "Recevez des notifications en temps réel, ajustez vos créneaux de livraison et programmez un retour.",
        account_cta_title: "Activez Vision+",
        account_cta_copy: "Accès prioritaire aux drops, personnalisation des pièces et retours gratuits.",
        account_cta_button: "Découvrir Vision+",
        cart_tag: "Panier",
        cart_title: "Vos sélections Vision",
        cart_intro: "Ajustez les quantités, appliquez vos codes promo et choisissez votre mode de livraison.",
        cart_summary_title: "Récapitulatif",
        cart_subtotal: "Sous-total",
        cart_shipping: "Livraison estimée",
        cart_total: "Total",
        cart_promo: "Code promo",
        cart_apply: "Appliquer",
        cart_checkout: "Passer au paiement sécurisé",
        cart_secure_note: "Transactions sécurisées (CB, PayPal, Apple Pay). Garantie satisfait ou remboursé 30 jours.",
        cart_delivery_title: "Livraison agile",
        cart_delivery_copy: "Choisissez entre express, standard ou point relais. Suivi en temps réel sur votre espace Vision.",
        cart_returns_title: "Retours simplifiés",
        cart_returns_copy: "Préparez votre retour en ligne, choisissez la collecte à domicile ou déposez dans un point relais.",
        cart_support_title: "Support 24/7",
        cart_support_copy: "Live chat, WhatsApp, email. Réponse sous 15 minutes pour les commandes en cours.",
        legal_tag: "Légal",
        legal_title: "Mentions légales & Conditions générales de vente",
        legal_intro: "Informations officielles de la marque Vision, détaillant notre statut juridique, les conditions de vente et les garanties associées.",
        legal_terms_title: "Mentions légales",
        legal_terms_intro: "Ce contenu est fourni à titre de maquette. Les informations officielles seront intégrées lorsque les documents juridiques seront finalisés.",
        legal_terms_company: "Vision Wear SAS — Capital social à définir — RCS Paris.",
        legal_terms_address: "Siège social : 18 rue Horizon, 75010 Paris, France.",
        legal_terms_contact: "Contact : legal@visionwear.com — +33 (0)1 00 00 00 00.",
        legal_terms_director: "Directeur de publication : Aliyah Chen.",
        legal_terms_host: "Hébergeur : à confirmer.",
        legal_cgv_title: "Conditions générales de vente",
        legal_cgv_intro: "Ces CGV seront remplacées par le document officiel communiqué par l'équipe juridique.",
        legal_cgv_1: "Objet : définir les modalités de vente en ligne des produits Vision.",
        legal_cgv_2: "Produits : vêtements et accessoires streetwear, quantités limitées, disponibilité temps réel.",
        legal_cgv_3: "Prix : affichés en EUR avec TVA incluse. Conversion automatique selon la devise du pays de livraison.",
        legal_cgv_4: "Commande : validation après email de confirmation. Possibilité de suivi via l'espace client.",
        legal_cgv_5: "Paiement : cartes bancaires, PayPal, wallets numériques. Sécurisation via protocole 3D Secure.",
        legal_cgv_6: "Livraison : internationale, délais indicatifs communiqués avant paiement, suivi en temps réel.",
        legal_cgv_7: "Retours : 30 jours, produits non portés. Remboursement sous 7 jours après validation.",
        legal_cgv_8: "Garanties : conformité légale, défauts de fabrication, service après-vente dédié.",
        legal_cgv_9: "Service client : support multilingue, contact@visionwear.com.",
        legal_cgv_10: "Droit applicable : droit français. Litiges soumis aux tribunaux compétents de Paris.",
        policies_tag: "Politiques",
        policies_title: "Confidentialité, retours, livraison & cookies",
        policies_intro: "Retrouvez l'ensemble des informations clés concernant la gestion de vos données, les retours, la livraison et vos préférences de cookies.",
        privacy_title: "Politique de confidentialité",
        privacy_intro: "Vision s'engage à protéger vos données personnelles. Le document complet sera publié dès validation juridique.",
        privacy_data: "Collecte limitée aux données nécessaires : identifiants, préférences, historique de commandes.",
        privacy_use: "Utilisation : gestion des commandes, personnalisation, newsletter Vision Loop.",
        privacy_rights: "Vos droits : accès, rectification, portabilité, suppression via privacy@visionwear.com.",
        privacy_security: "Sécurité : chiffrement, audits réguliers, hébergement conforme RGPD.",
        returns_title: "Politique de retour",
        returns_intro: "Les modalités officielles seront intégrées lors de la mise en ligne. Aperçu des engagements Vision :",
        returns_period: "Retour sous 30 jours, pièces non portées et étiquettes intactes.",
        returns_process: "Portail Vision Loop pour générer une étiquette prépayée et suivre votre dossier.",
        returns_refund: "Remboursement sous 7 jours ouvrés après réception et contrôle qualité.",
        returns_exchange: "Échanges possibles selon disponibilité en stock.",
        delivery_title: "Politique de livraison",
        delivery_intro: "Vision expédie à l'international en collaborant avec des partenaires logistiques responsables.",
        delivery_modes: "Modes : express 24/48h, standard 3-5 jours, relais 4-6 jours.",
        delivery_tracking: "Suivi temps réel via l'espace client et notifications SMS.",
        delivery_fees: "Frais calculés selon le pays, offerts dès 200 € d'achat.",
        delivery_green: "Option green : compensation carbone, emballages recyclés.",
        cookies_title: "Politique cookies & préférences",
        cookies_intro: "Vision respecte le RGPD. Cette section sera connectée à une CMP (Consent Management Platform) lors du développement final.",
        cookies_necessary: "Cookies essentiels : indispensables au fonctionnement (authentification, panier).",
        cookies_analytics: "Cookies analytiques : mesure d'audience anonymisée.",
        cookies_marketing: "Cookies marketing : personnalisation des offres et campagnes.",
        cookies_preferences: "Vous pouvez ajuster vos préférences à tout moment depuis le bandeau cookies ou votre compte."
    },
    en: {}
};

translations.en = Object.fromEntries(
    Object.entries(translations.fr).map(([key, value]) => {
        const dictionary = {
            Accueil: "Home",
            "Boutique": "Shop",
            "À propos": "About",
            Contact: "Contact",
            "Mon compte": "Account",
            Panier: "Cart",
            "Passer en anglais": "Switch to English",
            "Passer en français": "Switch to French",
            "Mode clair": "Light mode",
            "Mode sombre": "Dark mode",
            "Politiques": "Policies",
            "Nouvelle vague streetwear": "New streetwear wave",
            "Vision — L'élégance urbaine taillée pour le quotidien": "Vision — Urban elegance tailored for everyday life",
            "Des silhouettes minimalistes, des matières responsables et une allure qui capte l'instant. Découvrez des pièces pensées pour bouger avec vous.": "Minimal silhouettes, responsible fabrics and an attitude that catches the moment. Discover pieces designed to move with you.",
            "Explorer la collection": "Explore the collection",
            "Voir les éditions limitées": "See limited editions",
            "Drop Vision 07": "Vision Drop 07",
            "Parka technique, hoodie double épaisseur, pantalon cargo texturé.": "Technical parka, double-layer hoodie, textured cargo pant.",
            "Découvrir la capsule": "Discover the capsule",
            "Nouveautés": "New",
            "Sélection lumineuse": "Luminous selection",
            "Une zone claire pour repérer vos prochains essentiels": "A bright zone to spot your next essentials",
            "Visualisez dès maintenant trois emplacements produits dédiés à vos futurs best-sellers Vision.": "Preview three product placeholders ready for your future Vision best-sellers.",
            "Visuel 4:5": "4:5 visual",
            "Produit à venir": "Coming soon",
            "Emplacement produit n°1": "Product placeholder #1",
            "Réservez cet espace pour votre pièce phare : photo, nom, prix et appel à l'action s'y intégreront parfaitement.": "Reserve this space for your hero piece: imagery, name, price and CTA will slot in seamlessly.",
            "Emplacement produit n°2": "Product placeholder #2",
            "Mettez en avant une nouveauté ou une édition limitée avec visuel 3:4 et fiche descriptive concise.": "Spotlight a new arrival or limited drop with a 3:4 visual and concise write-up.",
            "Emplacement produit n°3": "Product placeholder #3",
            "Préparez ici votre drop exclusif : matériaux, storytelling et boutons d'ajout au panier seront mis en valeur.": "Stage your exclusive drop here: materials, storytelling and add-to-cart actions shine.",
            "Prix à définir": "Price TBD",
            "Bientôt disponible": "Coming soon",
            "Collections": "Collections",
            "Des pièces essentielles pour un dressing visionnaire": "Essential pieces for a visionary wardrobe",
            "Composez votre uniforme urbain avec des basiques revisités, des coupes oversize maîtrisées et des détails techniques pensés pour durer.": "Build your urban uniform with reworked staples, controlled oversized fits and durable technical details.",
            "Ligne Métropolis": "Metropolis Line",
            "Blousons modulaires, pantalons cargos ajustables et accessoires réfléchissants inspirés de la ville nocturne.": "Modular jackets, adjustable cargo pants and reflective accessories inspired by the night city.",
            "Shopper la ligne": "Shop the line",
            "Essentials 24/7": "Essentials 24/7",
            "Hoodies premium, tees respirants et joggers sculptés pour l'agilité. Le confort sans compromis.": "Premium hoodies, breathable tees and sculpted joggers for agility. Comfort without compromise.",
            "Shopper les essentiels": "Shop essentials",
            "Fluid Dynamics": "Fluid Dynamics",
            "Pièces unisexes, tissus techniques semi-transparents et superpositions légères inspirées du mouvement.": "Genderless pieces, semi-transparent technical fabrics and light layering inspired by movement.",
            "Shopper la capsule": "Shop the capsule",
            "Manifeste": "Manifesto",
            "Un vestiaire engagé pour une communauté en mouvement": "A committed wardrobe for a community in motion",
            "Production responsable en ateliers certifiés en Europe et au Japon.": "Responsible production in certified workshops across Europe and Japan.",
            "Matériaux recyclés, coton bio, cuir vegan et emballages compostables.": "Recycled materials, organic cotton, vegan leather and compostable packaging.",
            "Création inclusive : coupes pensées pour toutes les morphologies.": "Inclusive design: fits tailored to every body.",
            "Lire notre histoire": "Read our story",
            "de clients satisfaits": "customer satisfaction",
            "Expédition moyenne": "Average shipping",
            "Pays livrés": "Countries delivered",
            "Éditions limitées": "Limited editions",
            "Drops exclusifs & collaborations visionnaires": "Exclusive drops & visionary collaborations",
            "Alertes en temps réel, quantités restreintes, design signature. Ne manquez aucun drop.": "Real-time alerts, limited quantities, signature design. Don't miss a drop.",
            "Collaboration": "Collab",
            "Série limitée": "Limited",
            Restock: "Restock",
            "Vision x Concrete Waves": "Vision x Concrete Waves",
            "Capsule inspirée des textures urbaines et des graffitis lumineux.": "Capsule inspired by urban textures and luminous graffiti.",
            "Accéder au drop": "Access the drop",
            "Programme Atelier 06": "Atelier Program 06",
            "Pièces numérotées, broderies à la main, packaging signature Vision.": "Numbered pieces, hand embroidery, Vision signature packaging.",
            "Réserver": "Reserve",
            "Archive Restock": "Archive Restock",
            "Les pièces iconiques reviennent en quantités très limitées.": "Iconic pieces return in very limited quantities.",
            "Être notifié·e": "Get notified",
            "Vue 360°": "360° view",
            "Interagissez avec nos pièces en 3D": "Interact with our pieces in 3D",
            "Manipulez chaque vêtement, inspectez les textures et choisissez la combinaison qui vous ressemble. La technologie Vision 360° rend l'expérience d'achat tactile.": "Handle each garment, inspect textures and choose the combo that fits you. Vision 360° technology makes shopping tactile.",
            "Visualisation multi-angle et zoom haute définition.": "Multi-angle viewing and high-definition zoom.",
            "Prévisualisation des variations de couleurs en temps réel.": "Preview color variations in real time.",
            "Compatibilité mobile, tablette et desktop.": "Compatible with mobile, tablet and desktop.",
            "Aperçu prototype — la modélisation finale sera intégrée lors de la réception des fichiers 3D.": "Prototype preview — final modeling will be integrated once 3D files are delivered.",
            "Services": "Services",
            "Une expérience e-commerce fluide et sécurisée": "A seamless, secure e-commerce experience",
            "Paiement sécurisé": "Secure payment",
            "Carte bancaire, PayPal et wallets numériques avec chiffrement AES-256.": "Cards, PayPal and digital wallets with AES-256 encryption.",
            "Livraison mondiale": "Worldwide shipping",
            "Suivi en temps réel, partenaires DHL Express & Chronopost, options green.": "Real-time tracking, DHL Express & Chronopost partners, green options.",
            "Retours simplifiés": "Simple returns",
            "Portail de retours intégré, étiquettes prépayées, remboursement rapide.": "Integrated returns portal, prepaid labels, fast refunds.",
            "Support humain": "Human support",
            "Support": "Support",
            "Équipe dédiée multilingue, réponses sous 24h et assistance live chat.": "Dedicated multilingual team, replies within 24h and live chat assistance.",
            Newsletter: "Newsletter",
            "Recevez les drops avant tout le monde": "Get drops before everyone",
            "Inscrivez-vous pour accéder aux préventes, codes promo exclusifs et invitations à nos évènements.": "Sign up for early access, exclusive promos and event invites.",
            "Votre email": "Your email",
            "S'inscrire": "Sign up",
            "Vision réinvente les essentiels urbains avec un regard responsable et avant-gardiste.": "Vision reinvents urban essentials with a responsible, forward-thinking approach.",
            "Ligne Métropolis": "Metropolis Line",
            "Essentials 24/7": "Essentials 24/7",
            "Fluid Dynamics": "Fluid Dynamics",
            "Drops exclusifs": "Exclusive drops",
            "Nous contacter": "Contact us",
            "Politique de retour": "Returns policy",
            "Livraison & suivi": "Shipping & tracking",
            "Confidentialité & cookies": "Privacy & cookies",
            "Mentions légales": "Legal notice",
            "Légal": "Legal",
            "Conditions générales de vente": "Terms of sale",
            "Préférences cookies": "Cookie preferences",
            "© Vision. Tous droits réservés.": "© Vision. All rights reserved.",
            "Budget : des toasts de chèvre ?": "Budget: goat cheese toasts?",
            "Vision utilise des cookies pour personnaliser votre expérience. Choisissez vos préférences.": "Vision uses cookies to tailor your experience. Choose your preferences.",
            "Paramétrer": "Manage",
            "Tout accepter": "Accept all",
            "Composez votre uniforme urbain": "Build your urban uniform",
            "Filtrez par catégorie, taille, couleur ou disponibilité pour trouver la pièce Vision qui vous correspond.": "Filter by category, size, color or availability to find your Vision piece.",
            "Catégorie": "Category",
            "Taille": "Size",
            "Couleur": "Color",
            "Disponibilité": "Availability",
            "Toutes": "All",
            "Métropolis": "Metropolis",
            "Essentials": "Essentials",
            "Éditions limitées": "Limited editions",
            "Noir": "Black",
            "Blanc": "White",
            "Gris": "Grey",
            "Accent chromé": "Chrome accent",
            "En stock": "In stock",
            "Précommande": "Preorder",
            "Edition limitée": "Limited edition",
            "Appliquer": "Apply",
            "Réinitialiser": "Reset",
            "Utilisez le code VISION15": "Use code VISION15",
            "15% de réduction sur votre première commande. Offre limitée aux 500 premiers clients.": "15% off your first order. Offer limited to the first 500 customers.",
            "Besoin d'un conseil style ?": "Need a style consult?",
            "Réservez une session en visio avec nos stylistes Vision pour créer votre tenue idéale.": "Book a video session with our stylists to craft your look.",
            "Planifier une session": "Book a session",
            "Vision : l'esthétique streetwear pensée pour durer": "Vision: streetwear aesthetics built to last",
            "Notre univers": "Our universe",
            "Née dans les rues de Paris et façonnée par une communauté internationale, Vision repense les essentiels urbains avec exigence et conscience.": "Born in Paris streets and shaped by an international community, Vision rethinks urban essentials with care and conscience.",
            "2016 — Origines": "2016 — Origins",
            "Lancement de Vision avec une première série de hoodies produits en édition limitée et sérigraphiés à la main.": "Vision launches with a limited run of hand-screened hoodies.",
            "2018 — Communauté": "2018 — Community",
            "Ouverture du studio Vision à Paris, ateliers co-créatifs avec les clients et premières collaborations avec des artistes visuels.": "Vision studio opens in Paris, co-creation workshops with clients and first artist collabs.",
            "2021 — Expansion": "2021 — Expansion",
            "Distribution internationale, lancement de la plateforme e-commerce et introduction des gammes techniques.": "International distribution, e-commerce launch and technical lines debut.",
            "2024 — Innovation": "2024 — Innovation",
            "Intégration de la modélisation 3D, logistique bas carbone et programme de recyclage Vision Loop.": "3D modeling integration, low-carbon logistics and Vision Loop recycling program.",
            "Créer des pièces qui racontent les villes et respectent la planète": "Create pieces that tell city stories and respect the planet",
            "Chaque collection est conçue à partir de matériaux premium et responsables. Nous travaillons avec des ateliers certifiés, privilégions des séries limitées pour éviter la surproduction et offrons une traçabilité complète.": "Each collection uses premium, responsible materials. We partner with certified workshops, favor limited runs to avoid overproduction and provide full traceability.",
            "Mission": "Mission",
            "Vision": "Vision",
            "Une marque pensée pour la communauté": "A brand built for the community",
            "Vision défend la diversité, l'inclusivité et l'expression personnelle. Nos campagnes donnent la parole aux clients, artistes, athlètes et créatifs qui nous inspirent.": "Vision champions diversity, inclusivity and self-expression. Our campaigns spotlight customers, artists, athletes and creatives who inspire us.",
            "Nos piliers": "Our pillars",
            "Design fonctionnel": "Functional design",
            "Coupes étudiées, poches intelligentes, tissus respirants et résistance à l'eau pour accompagner les rythmes urbains.": "Refined cuts, smart pockets, breathable and water-resistant fabrics to match urban rhythms.",
            "Culture street": "Street culture",
            "Influencée par le skate, la musique électronique et l'art contemporain, Vision capte l'énergie des grandes villes.": "Shaped by skate, electronic music and contemporary art, Vision captures the energy of big cities.",
            "Responsabilité": "Responsibility",
            "Traçabilité complète, partenaires engagés, packaging recyclé et donation d'invendus à des associations.": "Full traceability, committed partners, recycled packaging and unsold donations to charities.",
            "L'équipe Vision": "The Vision team",
            "Une équipe multidisciplinaire mêlant designers, stylistes, développeurs, logisticiens et storytellers.": "A multidisciplinary crew of designers, stylists, developers, logisticians and storytellers.",
            "Directrice créative — imagine les silhouettes et collabore avec des artistes émergents.": "Creative Director — imagines silhouettes and collaborates with emerging artists.",
            "Head of Digital — pilote l'expérience e-commerce, la 3D et les innovations retail.": "Head of Digital — drives e-commerce, 3D and retail innovation.",
            "Responsable production — garantit la qualité, la traçabilité et la logistique bas carbone.": "Production lead — ensures quality, traceability and low-carbon logistics.",
            "Parlons de votre expérience Vision": "Let's talk about your Vision experience",
            "Support client, collaborations, presse ou wholesale — notre équipe est disponible en français et en anglais.": "Customer care, collabs, press or wholesale — we're here in French and English.",
            "Nom complet": "Full name",
            "Email": "Email",
            "Sujet": "Topic",
            "Message": "Message",
            "Support commande": "Order support",
            "Support client": "Customer support",
            "Collaboration": "Collaboration",
            "Presse": "Press",
            "Presse & collaborations": "Press & collaborations",
            "Wholesale": "Wholesale",
            "Envoyer": "Send",
            "Disponible du lundi au samedi, 9h-20h CET.": "Available Monday to Saturday, 9am-8pm CET.",
            "Envoyez vos dossiers de presse, portfolios et propositions de projets.": "Send your press kits, portfolios and project proposals.",
            "Visite sur rendez-vous, essayage privé et personnalisation.": "Visit by appointment, private fitting and customization.",
            "Showroom Vision": "Vision showroom",
            "Recyclage de vêtements, offres exclusives et invitations à nos évènements immersifs.": "Garment recycling, exclusive offers and invites to immersive events.",
            "Rejoignez la communauté Vision Loop": "Join the Vision Loop community",
            "S'inscrire": "Join",
            "Gérez votre profil Vision": "Manage your Vision profile",
            "Suivez vos commandes, gérez vos adresses, vos préférences de livraison et vos listes d'envies.": "Track orders, manage addresses, delivery preferences and wishlists.",
            "Connexion": "Sign in",
            "Créer un compte": "Create an account",
            "Suivi de commande": "Order tracking",
            "Mon espace": "My space",
            "Mot de passe": "Password",
            "Se connecter": "Sign in",
            "Mot de passe oublié ?": "Forgot password?",
            "Préférences": "Preferences",
            "Streetwear structuré": "Structured streetwear",
            "Casual minimal": "Casual minimal",
            "Drops exclusifs": "Exclusive drops",
            "Créer mon compte": "Create my account",
            "Je souhaite recevoir la newsletter Vision.": "I want to receive the Vision newsletter.",
            "Numéro de commande": "Order number",
            "Suivre": "Track",
            "Recevez des notifications en temps réel, ajustez vos créneaux de livraison et programmez un retour.": "Get real-time notifications, adjust delivery slots and schedule returns.",
            "Activez Vision+": "Activate Vision+",
            "Accès prioritaire aux drops, personnalisation des pièces et retours gratuits.": "Priority drops, product customization and free returns.",
            "Découvrir Vision+": "Discover Vision+",
            "Vos sélections Vision": "Your Vision picks",
            "Ajustez les quantités, appliquez vos codes promo et choisissez votre mode de livraison.": "Adjust quantities, apply promo codes and pick your delivery method.",
            "Récapitulatif": "Summary",
            "Sous-total": "Subtotal",
            "Livraison estimée": "Estimated shipping",
            "Total": "Total",
            "Code promo": "Promo code",
            "Passer au paiement sécurisé": "Proceed to secure payment",
            "Transactions sécurisées (CB, PayPal, Apple Pay). Garantie satisfait ou remboursé 30 jours.": "Secure checkout (card, PayPal, Apple Pay). 30-day satisfaction guarantee.",
            "Livraison agile": "Agile delivery",
            "Choisissez entre express, standard ou point relais. Suivi en temps réel sur votre espace Vision.": "Choose express, standard or pick-up point. Real-time tracking in your Vision space.",
            "Retours simplifiés": "Easy returns",
            "Préparez votre retour en ligne, choisissez la collecte à domicile ou déposez dans un point relais.": "Arrange returns online, schedule home pickup or drop at a hub.",
            "Support 24/7": "24/7 support",
            "Live chat, WhatsApp, email. Réponse sous 15 minutes pour les commandes en cours.": "Live chat, WhatsApp, email. Under 15-min response for active orders.",
            "Mentions légales & Conditions générales de vente": "Legal notice & Terms of sale",
            "Informations officielles de la marque Vision, détaillant notre statut juridique, les conditions de vente et les garanties associées.": "Official Vision information outlining legal status, sales terms and guarantees.",
            "Ce contenu est fourni à titre de maquette. Les informations officielles seront intégrées lorsque les documents juridiques seront finalisés.": "Content provided as a mockup. Official information will be added once documents are final.",
            "Vision Wear SAS — Capital social à définir — RCS Paris.": "Vision Wear Ltd — Share capital TBD — Paris Trade Register.",
            "Siège social : 18 rue Horizon, 75010 Paris, France.": "Head office: 18 rue Horizon, 75010 Paris, France.",
            "Contact : legal@visionwear.com — +33 (0)1 00 00 00 00.": "Contact: legal@visionwear.com — +33 (0)1 00 00 00 00.",
            "Directeur de publication : Aliyah Chen.": "Publishing director: Aliyah Chen.",
            "Hébergeur : à confirmer.": "Hosting provider: TBC.",
            "Ces CGV seront remplacées par le document officiel communiqué par l'équipe juridique.": "These terms will be replaced by the official legal document.",
            "Objet : définir les modalités de vente en ligne des produits Vision.": "Purpose: define online sales terms for Vision products.",
            "Produits : vêtements et accessoires streetwear, quantités limitées, disponibilité temps réel.": "Products: streetwear apparel & accessories, limited quantities, real-time stock.",
            "Prix : affichés en EUR avec TVA incluse. Conversion automatique selon la devise du pays de livraison.": "Prices: displayed in EUR incl. VAT. Automatic conversion to delivery currency.",
            "Commande : validation après email de confirmation. Possibilité de suivi via l'espace client.": "Orders: confirmed via email, with tracking from your account.",
            "Paiement : cartes bancaires, PayPal, wallets numériques. Sécurisation via protocole 3D Secure.": "Payment: cards, PayPal, digital wallets. 3D Secure protection.",
            "Livraison : internationale, délais indicatifs communiqués avant paiement, suivi en temps réel.": "Shipping: worldwide, estimated lead times shown before payment, real-time tracking.",
            "Retours : 30 jours, produits non portés. Remboursement sous 7 jours après validation.": "Returns: 30 days, unworn items. Refund within 7 days after validation.",
            "Garanties : conformité légale, défauts de fabrication, service après-vente dédié.": "Guarantees: legal compliance, manufacturing defects, dedicated support.",
            "Service client : support multilingue, contact@visionwear.com.": "Customer service: multilingual support, contact@visionwear.com.",
            "Droit applicable : droit français. Litiges soumis aux tribunaux compétents de Paris.": "Governing law: French law. Disputes handled by Paris courts.",
            "Confidentialité, retours, livraison & cookies": "Privacy, returns, shipping & cookies",
            "Retrouvez l'ensemble des informations clés concernant la gestion de vos données, les retours, la livraison et vos préférences de cookies.": "All the key information about data, returns, shipping and cookie preferences.",
            "Politique de confidentialité": "Privacy policy",
            "Vision s'engage à protéger vos données personnelles. Le document complet sera publié dès validation juridique.": "Vision protects your personal data. Full policy published after legal validation.",
            "Collecte limitée aux données nécessaires : identifiants, préférences, historique de commandes.": "Collection limited to essentials: identifiers, preferences, order history.",
            "Utilisation : gestion des commandes, personnalisation, newsletter Vision Loop.": "Use: order management, personalization, Vision Loop newsletter.",
            "Vos droits : accès, rectification, portabilité, suppression via privacy@visionwear.com.": "Your rights: access, rectification, portability, deletion via privacy@visionwear.com.",
            "Sécurité : chiffrement, audits réguliers, hébergement conforme RGPD.": "Security: encryption, regular audits, GDPR-compliant hosting.",
            "Politique de retour": "Returns policy",
            "Les modalités officielles seront intégrées lors de la mise en ligne. Aperçu des engagements Vision :": "Official terms will go live soon. Here's our commitment preview:",
            "Retour sous 30 jours, pièces non portées et étiquettes intactes.": "Return within 30 days, unworn items with tags.",
            "Portail Vision Loop pour générer une étiquette prépayée et suivre votre dossier.": "Vision Loop portal to generate prepaid labels and track cases.",
            "Remboursement sous 7 jours ouvrés après réception et contrôle qualité.": "Refund within 7 business days after inspection.",
            "Échanges possibles selon disponibilité en stock.": "Exchanges available subject to stock.",
            "Politique de livraison": "Shipping policy",
            "Vision expédie à l'international en collaborant avec des partenaires logistiques responsables.": "Vision ships worldwide with responsible logistics partners.",
            "Modes : express 24/48h, standard 3-5 jours, relais 4-6 jours.": "Options: express 24/48h, standard 3-5 days, pickup 4-6 days.",
            "Suivi temps réel via l'espace client et notifications SMS.": "Real-time tracking through your account and SMS alerts.",
            "Frais calculés selon le pays, offerts dès 200 € d'achat.": "Fees vary by country, free from €200.",
            "Option green : compensation carbone, emballages recyclés.": "Green option: carbon offset, recycled packaging.",
            "Politique cookies & préférences": "Cookie policy & preferences",
            "Vision respecte le RGPD. Cette section sera connectée à une CMP (Consent Management Platform) lors du développement final.": "Vision complies with GDPR. This section will connect to a CMP in the final build.",
            "Cookies essentiels : indispensables au fonctionnement (authentification, panier).": "Essential cookies: required for auth and cart.",
            "Cookies analytiques : mesure d'audience anonymisée.": "Analytics cookies: anonymized audience measurement.",
            "Cookies marketing : personnalisation des offres et campagnes.": "Marketing cookies: tailored offers and campaigns.",
            "Vous pouvez ajuster vos préférences à tout moment depuis le bandeau cookies ou votre compte.": "Adjust preferences anytime from the banner or your account."
        };
        return [key, dictionary[value] || value];
    })
);

const THEME_STORAGE_KEY = "vision-theme";
const THEME_COOKIE_KEY = "vision_theme";
const LANG_COOKIE_KEY = "vision_lang";
const PRODUCTS_ENDPOINT = "api/products.php";
const CART_ENDPOINT = "api/cart.php";

const getCurrentLanguage = () => (document.documentElement.lang === "fr" ? "fr" : "en");

const updateBrandLogo = (theme) => {
    const logos = document.querySelectorAll(".brand-logo");
    logos.forEach((logo) => {
        const darkSrc = logo.getAttribute("data-logo-dark");
        const lightSrc = logo.getAttribute("data-logo-light");
        if (theme === "light" && lightSrc) {
            logo.setAttribute("src", lightSrc);
        } else if (theme === "dark" && darkSrc) {
            logo.setAttribute("src", darkSrc);
        }
    });
};

const updateThemeToggleLabel = (lang = getCurrentLanguage()) => {
    const themeToggle = document.querySelector(".theme-toggle");
    if (!themeToggle) return;

    const currentTheme = document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
    const labelKey = currentTheme === "light" ? "theme_toggle_dark" : "theme_toggle_light";
    const label = (translations[lang] && translations[lang][labelKey]) || translations.fr[labelKey];
    const labelEl = themeToggle.querySelector(".theme-label");

    if (labelEl && label) {
        labelEl.textContent = label;
    }

    if (label) {
        themeToggle.setAttribute("aria-label", label);
    }

    themeToggle.dataset.state = currentTheme;
    themeToggle.setAttribute("aria-pressed", currentTheme === "light" ? "true" : "false");
};

const applyTheme = (theme) => {
    const normalized = theme === "light" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", normalized);
    try {
        localStorage.setItem(THEME_STORAGE_KEY, normalized);
    } catch (error) {
        // ignore storage errors (private mode)
    }
    document.cookie = `${THEME_COOKIE_KEY}=${normalized};path=/;max-age=31536000;samesite=Lax`;
    updateBrandLogo(normalized);
    updateThemeToggleLabel();
};

const updateLangToggleUI = (lang) => {
    const toggle = document.querySelector(".lang-toggle");
    if (!toggle) return;

    const currentLang = lang === "fr" ? "fr" : "en";
    const targetLang = currentLang === "fr" ? "en" : "fr";
    const flag = toggle.querySelector(".flag");
    const labelEl = toggle.querySelector(".lang-toggle-label");
    const labelKey = targetLang === "en" ? "lang_toggle_to_en" : "lang_toggle_to_fr";
    const label = (translations[currentLang] && translations[currentLang][labelKey]) || translations.fr[labelKey];

    if (flag) {
        flag.textContent = targetLang === "en" ? "🇬🇧" : "🇫🇷";
    }

    if (labelEl) {
        labelEl.textContent = label;
    }

    toggle.setAttribute("aria-label", label);
    toggle.dataset.lang = currentLang;
};

const initThemeToggle = () => {
    const themeToggle = document.querySelector(".theme-toggle");
    if (!themeToggle) return;

    let initialTheme = document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
    const cookieMatch = document.cookie.match(new RegExp(`(?:^|; )${THEME_COOKIE_KEY}=([^;]+)`));
    if (cookieMatch) {
        initialTheme = cookieMatch[1] === "light" ? "light" : "dark";
    }

    try {
        const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        if (storedTheme) {
            initialTheme = storedTheme;
        } else if (!cookieMatch && window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) {
            initialTheme = "light";
        }
    } catch (error) {
        initialTheme = cookieMatch && cookieMatch[1] === "light" ? "light" : document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
    }

    applyTheme(initialTheme);

    themeToggle.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
        const nextTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(nextTheme);
    });

    updateThemeToggleLabel();
};

function formatCurrency(value, lang, currency = "EUR") {
    return new Intl.NumberFormat(lang === "fr" ? "fr-FR" : "en-US", {
        style: "currency",
        currency: currency || "EUR",
    }).format(value);
}

function calculateTotalsFromItems(items) {
    const summary = items.reduce(
        (acc, item) => {
            const price = typeof item.price === "number" ? item.price : parseFloat(item.priceValue || item.price || 0);
            const quantity = typeof item.quantity === "number" ? item.quantity : 1;
            if (!Number.isNaN(price) && price > 0) {
                acc.subtotal += price * quantity;
            }
            if (item.currency) {
                acc.currency = item.currency;
            }
            return acc;
        },
        { subtotal: 0, currency: "EUR" }
    );

    const shipping = summary.subtotal >= 200 ? 0 : summary.subtotal > 0 ? 12 : 0;
    return {
        subtotal: Math.round(summary.subtotal * 100) / 100,
        shipping,
        total: Math.round((summary.subtotal + shipping) * 100) / 100,
        currency: summary.currency || "EUR",
    };
}

const fallbackProducts = [
    {
        id: "metropolis-parka",
        slug: "metropolis-parka",
        name: { fr: "Parka Métropolis", en: "Metropolis Parka" },
        description: {
            fr: "Blouson technique avec isolation recyclée et finitions réfléchissantes.",
            en: "Technical jacket with recycled insulation and reflective finishes.",
        },
        price: { fr: "420 €", en: "€420" },
        priceValue: 420,
        currency: "EUR",
        category: "metropolis",
        size: ["s", "m", "l"],
        color: "black",
        availability: "in-stock",
        tag: { fr: "Best-seller", en: "Best seller" },
    },
    {
        id: "essentials-hoodie",
        slug: "essentials-hoodie",
        name: { fr: "Hoodie Essentials double épaisseur", en: "Double-layer Essentials Hoodie" },
        description: {
            fr: "Molleton brossé, coutures thermosoudées et capuche structurée.",
            en: "Brushed fleece, heat-sealed seams and structured hood.",
        },
        price: { fr: "190 €", en: "€190" },
        priceValue: 190,
        currency: "EUR",
        category: "essentials",
        size: ["xs", "s", "m", "l", "xl"],
        color: "grey",
        availability: "in-stock",
        tag: { fr: "Nouveau", en: "New" },
    },
    {
        id: "fluid-windbreaker",
        slug: "fluid-windbreaker",
        name: { fr: "Windbreaker Fluid Dynamics", en: "Fluid Dynamics Windbreaker" },
        description: {
            fr: "Membrane respirante, ventilation latérale et cordons ajustables.",
            en: "Breathable membrane, side vents and adjustable cords.",
        },
        price: { fr: "260 €", en: "€260" },
        priceValue: 260,
        currency: "EUR",
        category: "fluid",
        size: ["s", "m", "l"],
        color: "accent",
        availability: "preorder",
        tag: { fr: "Précommande", en: "Preorder" },
    },
    {
        id: "atelier-sneakers",
        slug: "atelier-sneakers",
        name: { fr: "Sneakers Atelier 06", en: "Atelier 06 Sneakers" },
        description: {
            fr: "Edition numérotée réalisée dans nos ateliers parisiens.",
            en: "Numbered edition crafted in our Paris atelier.",
        },
        price: { fr: "320 €", en: "€320" },
        priceValue: 320,
        currency: "EUR",
        category: "limited",
        size: ["s", "m", "l"],
        color: "white",
        availability: "restock",
        tag: { fr: "Édition limitée", en: "Limited" },
    },
];

let products = [...fallbackProducts];

const fallbackCart = [
    {
        id: "metropolis-parka",
        name: { fr: "Parka Métropolis", en: "Metropolis Parka" },
        price: 420,
        currency: "EUR",
        size: "M",
        color: "Black",
        quantity: 1,
    },
    {
        id: "essentials-hoodie",
        name: { fr: "Hoodie Essentials double épaisseur", en: "Double-layer Essentials Hoodie" },
        price: 190,
        currency: "EUR",
        size: "L",
        color: "Charcoal",
        quantity: 2,
    },
];

let cartItems = [...fallbackCart];
let cartTotals = calculateTotalsFromItems(cartItems);

const normalizeProduct = (product = {}) => {
    const name = product.name || {};
    const priceValueCandidate =
        typeof product.priceValue === "number"
            ? product.priceValue
            : typeof product.price === "number"
            ? product.price
            : parseFloat(product.price_amount ?? product.price ?? 0);
    const priceValue = Number.isFinite(priceValueCandidate) && priceValueCandidate > 0 ? priceValueCandidate : 0;
    const currency = product.currency || (product.price && product.price.currency) || "EUR";
    const tag = product.tag || product.badge || {};
    const size = Array.isArray(product.size)
        ? product.size
        : Array.isArray(product.sizes)
        ? product.sizes
        : typeof product.size === "string" && product.size.length
        ? product.size.split(",").map((value) => value.trim()).filter(Boolean)
        : [];
    const color = product.color || (Array.isArray(product.colors) ? product.colors[0] : "black");
    const availability = product.availability || product.status || "in-stock";
    const description = product.description || {};

    const resolvedId = product.id || product.slug || `vision-product-${Math.random().toString(36).slice(2, 10)}`;
    const localizedName = {
        fr: name.fr || product.name_fr || name.en || "Produit Vision",
        en: name.en || product.name_en || name.fr || "Vision product",
    };

    const localizedDescription = {
        fr: description.fr || product.description_fr || description.en || "",
        en: description.en || product.description_en || description.fr || "",
    };

    const localizedPrice =
        typeof product.price === "object" && !Array.isArray(product.price)
            ? {
                  fr: product.price.fr || formatCurrency(priceValue, "fr", currency),
                  en: product.price.en || formatCurrency(priceValue, "en", currency),
              }
            : {
                  fr: formatCurrency(priceValue, "fr", currency),
                  en: formatCurrency(priceValue, "en", currency),
              };

    const localizedTag =
        typeof tag === "object" && !Array.isArray(tag)
            ? { fr: tag.fr || tag.en || "", en: tag.en || tag.fr || "" }
            : { fr: tag || "", en: tag || "" };

    return {
        ...product,
        id: resolvedId,
        slug: product.slug || resolvedId,
        name: localizedName,
        description: localizedDescription,
        priceValue,
        price: localizedPrice,
        currency,
        category: product.category || product.collection || "all",
        size,
        color,
        availability,
        tag: localizedTag,
    };
};

const normalizeCartItem = (item = {}) => {
    const name = item.name || {};
    const quantity = typeof item.quantity === "number" ? item.quantity : parseInt(item.quantity ?? 1, 10) || 1;
    const priceValue =
        typeof item.price === "number"
            ? item.price
            : typeof item.priceValue === "number"
            ? item.priceValue
            : parseFloat(item.unit_price ?? item.price ?? 0) || 0;

    return {
        id: item.id || item.product_id || "",
        line_id: item.line_id || item.uid || generateLineIdFallback(item),
        name: {
            fr: name.fr || item.name_fr || name.en || "Produit Vision",
            en: name.en || item.name_en || name.fr || "Vision product",
        },
        price: priceValue,
        currency: item.currency || "EUR",
        size: item.size || item.variant_size || "",
        color: item.color || item.variant_color || "",
        quantity,
    };
};

const generateLineIdFallback = (item) => {
    const id = item.id || item.product_id || "item";
    const size = item.size || item.variant_size || "";
    const color = item.color || item.variant_color || "";
    return `${id}-${size}-${color}`;
};

const assignCartData = (items, totals) => {
    cartItems = Array.isArray(items) ? items.map(normalizeCartItem) : [];
    if (totals && typeof totals === "object") {
        cartTotals = {
            subtotal: Number(totals.subtotal) || 0,
            shipping: Number(totals.shipping) || 0,
            total: Number(totals.total) || 0,
            currency: totals.currency || "EUR",
        };
    } else {
        cartTotals = calculateTotalsFromItems(cartItems);
    }
};

const resolveProductPriceLabel = (product, lang) => {
    if (product.price && product.price[lang]) {
        return product.price[lang];
    }
    return formatCurrency(product.priceValue || 0, lang, product.currency || "EUR");
};

const resolveProductTagLabel = (product, lang) => {
    if (product.tag && product.tag[lang]) {
        return product.tag[lang];
    }
    return "";
};

const fetchProducts = async () => {
    try {
        const response = await fetch(PRODUCTS_ENDPOINT, {
            headers: { Accept: "application/json" },
            credentials: "same-origin",
        });
        if (!response.ok) throw new Error("Products request failed");
        const data = await response.json();
        const list = Array.isArray(data) ? data : Array.isArray(data?.items) ? data.items : [];
        if (list.length) {
            products = list.map(normalizeProduct);
        } else {
            products = [...fallbackProducts];
        }
    } catch (error) {
        console.warn("Using fallback products", error);
        products = [...fallbackProducts];
    }
};

const fetchCart = async () => {
    try {
        const response = await fetch(CART_ENDPOINT, {
            headers: { Accept: "application/json" },
            credentials: "same-origin",
        });
        if (!response.ok) throw new Error("Cart request failed");
        const data = await response.json();
        if (Array.isArray(data)) {
            assignCartData(data, null);
        } else {
            assignCartData(data.items, data.totals);
        }
    } catch (error) {
        console.warn("Using fallback cart", error);
        assignCartData(fallbackCart, calculateTotalsFromItems(fallbackCart));
    }
};

const syncCart = async (payload) => {
    try {
        const response = await fetch(CART_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
            },
            credentials: "same-origin",
            body: JSON.stringify(payload),
        });
        if (!response.ok) throw new Error("Cart update failed");
        const data = await response.json();
        assignCartData(data.items, data.totals);
    } catch (error) {
        console.error(error);
        throw error;
    }
};

const renderProducts = (lang) => {
    const productList = document.querySelector("#product-list");
    if (!productList) return;

    productList.innerHTML = "";

    const filtersForm = document.querySelector("#filters-form");
    const filters = filtersForm ? new FormData(filtersForm) : new FormData();
    const selectedCategory = (filters.get("category") || "all").toString();
    const selectedSize = (filters.get("size") || "all").toString();
    const selectedColor = (filters.get("color") || "all").toString();
    const selectedAvailability = (filters.get("availability") || "all").toString();

    const filtered = products.filter((product) => {
        const sizes = Array.isArray(product.size) ? product.size : [];
        const colors = Array.isArray(product.colors) ? product.colors : [product.color];
        const categoryMatch = selectedCategory === "all" || product.category === selectedCategory;
        const sizeMatch = selectedSize === "all" || sizes.includes(selectedSize);
        const colorMatch = selectedColor === "all" || colors.includes(selectedColor);
        const availabilityMatch = selectedAvailability === "all" || product.availability === selectedAvailability;
        return categoryMatch && sizeMatch && colorMatch && availabilityMatch;
    });

    if (!filtered.length) {
        const empty = document.createElement("p");
        empty.className = "empty-state";
        empty.textContent = lang === "fr" ? "Aucun produit ne correspond à votre sélection pour le moment." : "No products match your filters yet.";
        productList.appendChild(empty);
        return;
    }

    filtered.forEach((product) => {
        const card = document.createElement("article");
        card.className = "product-card";

        const visual = document.createElement("div");
        visual.className = "product-image";
        visual.setAttribute("aria-hidden", "true");
        const placeholder = document.createElement("div");
        placeholder.className = "image-placeholder";
        const productName = product.name?.[lang] || product.name?.fr || product.name?.en || "Vision";
        placeholder.textContent = productName.split(" ")[0] || "Vision";
        visual.appendChild(placeholder);
        card.appendChild(visual);

        const meta = document.createElement("div");
        meta.className = "product-meta";
        const tagLabel = resolveProductTagLabel(product, lang);
        if (tagLabel) {
            const tagSpan = document.createElement("span");
            tagSpan.textContent = tagLabel;
            meta.appendChild(tagSpan);
        }
        const priceSpan = document.createElement("span");
        priceSpan.className = "price";
        priceSpan.textContent = resolveProductPriceLabel(product, lang);
        meta.appendChild(priceSpan);
        card.appendChild(meta);

        const title = document.createElement("h3");
        title.textContent = productName;
        card.appendChild(title);

        const description = document.createElement("p");
        description.textContent = product.description?.[lang] || translations[lang].collections_copy;
        card.appendChild(description);

        const button = document.createElement("button");
        button.className = "btn ghost add-to-cart";
        button.type = "button";
        button.dataset.productId = product.id;
        button.dataset.productAvailability = product.availability;
        const isSoldOut = product.availability === "sold-out";
        button.disabled = isSoldOut;
        button.textContent = isSoldOut ? (lang === "fr" ? "Épuisé" : "Sold out") : lang === "fr" ? "Ajouter au panier" : "Add to cart";
        card.appendChild(button);

        productList.appendChild(card);
    });
};

const renderCart = (lang) => {
    const cartContainer = document.querySelector("#cart-items");
    const subtotalEl = document.querySelector("#cart-subtotal");
    const shippingEl = document.querySelector("#cart-shipping");
    const totalEl = document.querySelector("#cart-total");

    if (!cartContainer || !subtotalEl || !shippingEl || !totalEl) return;

    cartContainer.innerHTML = "";

    if (!cartItems.length) {
        const empty = document.createElement("p");
        empty.className = "empty-state";
        empty.textContent = lang === "fr" ? "Votre panier est vide pour l'instant." : "Your cart is empty for now.";
        cartContainer.appendChild(empty);
        subtotalEl.textContent = formatCurrency(0, lang, cartTotals.currency);
        shippingEl.textContent = lang === "fr" ? "Offert" : "Free";
        totalEl.textContent = formatCurrency(0, lang, cartTotals.currency);
        return;
    }

    cartItems.forEach((item) => {
        const article = document.createElement("article");
        article.className = "cart-item";

        const visual = document.createElement("div");
        visual.className = "image-placeholder";
        const itemName = item.name?.[lang] || item.name?.fr || item.name?.en || "Vision";
        visual.textContent = itemName.split(" ")[0] || "Vision";
        article.appendChild(visual);

        const details = document.createElement("div");
        const nameHeading = document.createElement("h3");
        nameHeading.textContent = itemName;
        details.appendChild(nameHeading);

        const sizeLine = document.createElement("p");
        sizeLine.textContent = `${lang === "fr" ? "Taille" : "Size"}: ${item.size || (lang === "fr" ? "Unique" : "One size")}`;
        details.appendChild(sizeLine);

        const colorLine = document.createElement("p");
        colorLine.textContent = `${lang === "fr" ? "Couleur" : "Color"}: ${item.color || (lang === "fr" ? "Standard" : "Default")}`;
        details.appendChild(colorLine);

        article.appendChild(details);

        const controls = document.createElement("div");
        controls.className = "quantity-control";
        controls.setAttribute("role", "group");
        controls.setAttribute("aria-label", lang === "fr" ? "Quantité" : "Quantity");

        const decrease = document.createElement("button");
        decrease.type = "button";
        decrease.dataset.action = "decrease";
        decrease.dataset.lineId = item.line_id;
        decrease.setAttribute("aria-label", lang === "fr" ? "Réduire" : "Decrease");
        decrease.textContent = "-";
        controls.appendChild(decrease);

        const quantity = document.createElement("span");
        quantity.textContent = String(item.quantity);
        controls.appendChild(quantity);

        const increase = document.createElement("button");
        increase.type = "button";
        increase.dataset.action = "increase";
        increase.dataset.lineId = item.line_id;
        increase.setAttribute("aria-label", lang === "fr" ? "Augmenter" : "Increase");
        increase.textContent = "+";
        controls.appendChild(increase);

        article.appendChild(controls);
        cartContainer.appendChild(article);
    });

    subtotalEl.textContent = formatCurrency(cartTotals.subtotal, lang, cartTotals.currency);
    shippingEl.textContent = cartTotals.shipping === 0 ? (lang === "fr" ? "Offert" : "Free") : formatCurrency(cartTotals.shipping, lang, cartTotals.currency);
    totalEl.textContent = formatCurrency(cartTotals.total, lang, cartTotals.currency);
};

const bindAddToCart = () => {
    document.addEventListener("click", async (event) => {
        const button = event.target.closest(".add-to-cart");
        if (!button) return;

        const productId = button.dataset.productId;
        if (!productId || button.disabled) return;

        const availability = button.dataset.productAvailability;
        if (availability === "sold-out") return;

        button.disabled = true;
        button.classList.add("loading");

        try {
            await syncCart({
                action: "add",
                product_id: productId,
                quantity: 1,
                size: button.dataset.size || "",
                color: button.dataset.color || "",
            });
            renderCart(getCurrentLanguage());
        } catch (error) {
            console.error("Unable to add product to cart", error);
        } finally {
            button.classList.remove("loading");
            if (availability !== "sold-out") {
                button.disabled = false;
            }
        }
    });
};

const bindCartInteractions = () => {
    document.addEventListener("click", async (event) => {
        const button = event.target.closest("#cart-items button[data-action]");
        if (!button) return;

        const lineId = button.dataset.lineId;
        const action = button.dataset.action;
        if (!lineId || !action) return;

        const item = cartItems.find((entry) => entry.line_id === lineId);
        if (!item) return;

        try {
            if (action === "increase") {
                await syncCart({ action: "update", line_id: lineId, quantity: item.quantity + 1 });
            } else if (action === "decrease") {
                const nextQuantity = item.quantity - 1;
                if (nextQuantity <= 0) {
                    await syncCart({ action: "remove", line_id: lineId });
                } else {
                    await syncCart({ action: "update", line_id: lineId, quantity: nextQuantity });
                }
            }
            renderCart(getCurrentLanguage());
        } catch (error) {
            console.error("Unable to update cart", error);
        }
    });
};


const updateTranslations = (lang) => {
    document.documentElement.lang = lang === "fr" ? "fr" : "en";
    document.cookie = `${LANG_COOKIE_KEY}=${lang === "fr" ? "fr" : "en"};path=/;max-age=31536000;samesite=Lax`;
    document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (translations[lang][key]) {
            el.textContent = translations[lang][key];
        }
    });

    const ctaButtons = document.querySelectorAll(".hero-actions .btn, .hero-card .text-link, .btn.ghost, .btn");
    ctaButtons.forEach((button) => {
        button.setAttribute("aria-label", button.textContent);
    });

    updateLangToggleUI(lang);
    updateThemeToggleLabel(lang);

    renderProducts(lang);
    renderCart(lang);
};

const initLangToggle = () => {
    const toggle = document.querySelector(".lang-toggle");
    if (!toggle) return;

    let currentLang = toggle.dataset.lang === "en" ? "en" : "fr";
    const cookieMatch = document.cookie.match(new RegExp(`(?:^|; )${LANG_COOKIE_KEY}=([^;]+)`));
    if (cookieMatch) {
        currentLang = cookieMatch[1] === "en" ? "en" : "fr";
    }
    toggle.dataset.lang = currentLang;

    toggle.addEventListener("click", () => {
        currentLang = currentLang === "fr" ? "en" : "fr";
        updateTranslations(currentLang);
    });

    updateTranslations(currentLang);
};

const initNavToggle = () => {
    const navToggle = document.querySelector(".nav-toggle");
    const navList = document.querySelector(".nav-list");
    if (!navToggle || !navList) return;

    navToggle.addEventListener("click", () => {
        const expanded = navToggle.getAttribute("aria-expanded") === "true";
        navToggle.setAttribute("aria-expanded", String(!expanded));
        navList.classList.toggle("open");
    });
};

const initNewsletter = () => {
    const form = document.querySelector(".newsletter-form");
    if (!form) return;
    const feedback = form.querySelector(".form-feedback");

    form.addEventListener("submit", (event) => {
        event.preventDefault();
        const email = form.email.value.trim();
        if (!email) {
            feedback.textContent = document.documentElement.lang === "fr" ? "Veuillez renseigner un email." : "Please add your email.";
            return;
        }
        feedback.textContent = document.documentElement.lang === "fr" ? "Merci, votre inscription est confirmée !" : "Thanks, you're on the list!";
        form.reset();
    });
};

const initForms = () => {
    const forms = document.querySelectorAll("form");
    forms.forEach((form) => {
        const feedback = form.querySelector(".form-feedback");
        form.addEventListener("submit", (event) => {
            event.preventDefault();
            if (feedback) {
                feedback.textContent = document.documentElement.lang === "fr" ? "Prototype : action simulée." : "Prototype: action simulated.";
            }
        });
    });
};

const initFilters = () => {
    const filtersForm = document.querySelector("#filters-form");
    if (!filtersForm) return;

    filtersForm.addEventListener("submit", (event) => {
        event.preventDefault();
        renderProducts(getCurrentLanguage());
    });

    filtersForm.addEventListener("reset", () => {
        setTimeout(() => renderProducts(getCurrentLanguage()), 0);
    });
};

const initCookiesBanner = () => {
    const banner = document.querySelector(".cookies-banner");
    if (!banner) return;
    const accept = banner.querySelector('[data-action="cookies-accept"]');
    const settings = banner.querySelector('[data-action="cookies-settings"]');

    const showBanner = () => banner.classList.add("visible");
    const hideBanner = () => banner.classList.remove("visible");

    setTimeout(showBanner, 1500);

    accept?.addEventListener("click", hideBanner);
    settings?.addEventListener("click", () => {
        alert(document.documentElement.lang === "fr" ? "Interface de préférences à intégrer." : "Preferences interface coming soon.");
    });
};

const init = () => {
    initThemeToggle();
    initLangToggle();
    initNavToggle();
    initNewsletter();
    initForms();
    initFilters();
    bindAddToCart();
    bindCartInteractions();
    renderProducts(getCurrentLanguage());
    renderCart(getCurrentLanguage());
    fetchProducts().then(() => renderProducts(getCurrentLanguage()));
    fetchCart().then(() => renderCart(getCurrentLanguage()));
    initCookiesBanner();
};

document.addEventListener("DOMContentLoaded", init);
